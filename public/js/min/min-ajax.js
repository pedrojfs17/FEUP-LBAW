let csrf=document.querySelector('input[name="_token"]');const csrfToken=csrf?csrf.value:"";function encodeForAjax(e){return Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&")}function sendAjaxRequest(e,t,n,o,r){let a=new XMLHttpRequest;a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE){let e=JSON.parse(this.responseText);200===a.status?(o&&o(e),e.message&&showMessage(e.message)):r&&r(e)}},a.open(e,t,!0),a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(n)}function showMessage(e){const t=document.querySelector("#message-container");let n=document.createElement("div");n.innerHTML=e;let o=n.children[0];t.append(o),new bootstrap.Toast(o,{}).show(),o.addEventListener("hidden.bs.toast",function(){o.remove()})}const createForms=document.querySelectorAll(".create-form"),editForms=document.querySelectorAll(".edit-form");function addFormEventListener(e,t){e.addEventListener("submit",function(n){if(n.preventDefault(),!window[e.dataset.validateFunction]())return n.stopPropagation(),void e.classList.add("was-validated");let o={};new FormData(e).forEach((e,t)=>o[t]=e);sendAjaxRequest(t,e.dataset.href,encodeForAjax(o),window[e.dataset.onSubmit],function(t){serverSideValidation(e,t)})})}function addTagElement(e){const t=document.getElementById("project-tags");let n=document.createElement("div");n.innerHTML=e.delete_tag,checkColor(n.children[0]),t.append(n.children[0]),addDeleteEventListener(t.querySelector("div:last-of-type"))}function addTaskElement(e){const t=document.getElementById("overview"),n=t.querySelector("#createTaskCard");let o=document.createElement("div");o.innerHTML=e.taskCard;let r=o.children[0];t.insertBefore(r,n),r.querySelectorAll(".open-task").forEach(e=>addGetEventListener(e,null,onModalReceived))}createForms.forEach(e=>addFormEventListener(e,"POST")),editForms.forEach(e=>addFormEventListener(e,"PATCH"));const deleteButtons=document.querySelectorAll(".delete-button"),removeButtons=document.querySelectorAll(".remove-button");function addDeleteEventListener(e,t){e.addEventListener("click",function(n){n.preventDefault();sendAjaxRequest("DELETE",e.dataset.href,encodeForAjax({_token:csrfToken}),function(){t?t.forEach(e=>e.remove()):e.remove()})})}deleteButtons.forEach(e=>addDeleteEventListener(e)),removeButtons.forEach(e=>addDeleteEventListener(e,[e.parentElement.parentElement]));const toggleButtons=document.querySelectorAll(".edit-button"),changeRoleButtons=document.querySelectorAll(".edit-role-button"),settingsToggles=document.querySelectorAll(".settings-button"),colorInput=document.querySelectorAll(".color-input");function addUpdateEventListener(e){e.addEventListener("click",function(t){t.preventDefault();const n=document.getElementById(e.dataset.editInput);if(n.disabled)e.innerHTML='<i class="bi bi-check2"></i>',n.disabled=!1;else{e.innerHTML='<i class="bi bi-pencil"></i>',n.disabled=!0;let t={[e.dataset.editInput]:n.value,_token:csrfToken};sendAjaxRequest("PATCH",e.dataset.href,encodeForAjax(t),window[e.dataset.onEdit])}})}function addPatchOnClickEventListener(e){e.addEventListener("click",function(t){t.preventDefault();let n={member_role:e.innerText,_token:csrfToken};sendAjaxRequest("PATCH",e.dataset.href,encodeForAjax(n),window[e.dataset.onEdit])})}function updateProjectName(e){const t=document.querySelector("#project-title");t&&(t.innerText=e.name)}function updateUserRole(e){document.querySelector("#role-"+e.member.username).innerHTML=e.member.role}toggleButtons.forEach(e=>addUpdateEventListener(e)),changeRoleButtons.forEach(e=>addPatchOnClickEventListener(e)),settingsToggles.forEach(e=>{e.addEventListener("change",function(t){t.preventDefault(),sendAjaxRequest("PATCH","settings",encodeForAjax({[e.getAttribute("id")]:e.checked?1:0,_token:csrfToken}))})}),colorInput.forEach(e=>{e.addEventListener("change",function(t){t.preventDefault(),sendAjaxRequest("PATCH","settings",encodeForAjax({[e.getAttribute("id")]:e.value,_token:csrfToken}))})});const openTaskButtons=document.querySelectorAll(".open-task");function addGetEventListener(e,t,n){e.addEventListener("click",function(o){o.preventDefault(),sendAjaxRequest("GET",e.dataset.href+(t?"?"+encodeForAjax(t):""),null,n)})}function onModalReceived(e){const t=document.querySelector(".modal-container");t.innerHTML="";let n=document.createElement("div");n.innerHTML=e.taskModal;let o=n.children[0];t.append(o),new bootstrap.Modal(o,{}).show(),addModalEventListeners(o)}function addModalEventListeners(e){addEditButtonEventListner(e),addSaveButtonEventListner(e),addCancelButtonEventListner(e),addClearButtonEventListner(e),taskEventListener(e),e.querySelectorAll(".delete-task-button").forEach(t=>addDeleteEventListener(t,[e,document.getElementById("task-"+e.dataset.id)])),commentEventListener(e),e.querySelectorAll(".open-task").forEach(e=>addGetEventListener(e,null,onModalReceived)),e.querySelectorAll(".text-bg-check").forEach(e=>checkColor(e))}function addClearButtonEventListner(e){clearButtons=e.querySelectorAll(".clearButton"),clearButtons.forEach(e=>{e.addEventListener("click",t=>{const n=e.parentElement.children[0];if(!n.disabled){n.value="";let e=new Event("change");n.dispatchEvent(e)}})})}function clearFields(e){document.getElementById("changePassword").querySelectorAll("input").forEach(e=>{if("_token"!=e.name){e.value="";let t=new Event("change");e.dispatchEvent(t)}})}openTaskButtons.forEach(e=>addGetEventListener(e,null,onModalReceived)),addClearButtonEventListner(document);let projStatus=document.querySelector(".project-status");if(projStatus){let e=projStatus.querySelector("button");e.addEventListener("click",()=>{projStatusHandler(e)})}function projStatusHandler(e){let t=document.querySelector('input[name="_token"]').value;sendAjaxRequest("PATCH",e.dataset.href,encodeForAjax({closed:e.dataset.value,_token:t}),t=>{let n=document.createRange().createContextualFragment(t.projStatus).firstChild;e=n.querySelector("button"),n.addEventListener("click",()=>{projStatusHandler(e)}),projStatus.parentElement.replaceChild(n,projStatus),projStatus=n})}
